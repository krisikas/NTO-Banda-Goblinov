# NTO-Banda-Goblinov

| Трек      | Летающая робототехника |
| --------- | ---------------------- |
| Задание   | Командное задание      |
| Тип       | Инструкция             |
| Команда   | Банда гоблинов         |

| Участник           | Роль                    |
| ------------------ | ----------------------- |
| • Елисей Шибаев    | Капитан, инженер-техник |
| • Демьян Тарасов   | Инженер-программист     |
| • Тарас Резниченко | Программист             |
| • Михаил Ношин     | Программист             |
| • Ирина Урих       | Наставник               |


---

## 1. Описание задачи

Проект реализует систему мониторинга нефтепровода на базе квадрокоптера Clover в симуляторе Gazebo под управлением ROS, позволяющую сканировать основную трубу и находить все врезки (ответвления основной трубы).
Необходимо один раз взлететь, выполнить полёт вдоль трубопровода, определить координаты всех врезок в системе aruco_map, записать результаты в ROS‑топик /tubes и отобразить их в веб‑интерфейсе для оператора.

---

## 2. Формат вывода и материалы

В репозитории находится данный файл README.md с пошаговой инструкцией по запуску проекта, а также исходный код всех скриптов (launch.py, houses.py, colour_vse.py, server.py) и вспомогательные файлы мира.  
Дополнительно был записан видео ролик прохождения миссии, на котором одновременно видны окно симулятора, терминал с запуском кода и выводом топика /tubes, а также веб‑интерфейс управления миссией. 

[^1]*Так как программный код - объемная структурированная информация, он был прокомментирован и распределен на смысловые папки, каждая из которых была приложена выше. С ними вы также можете ознакомиться. 


---

## 3. Вклад каждого участника в выполнение командного задания (краткое описание)

| Участник           | Роль                    | Краткое описание вклада                                                                                                                                                                                                             |
| ------------------ | ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| • Елисей Шибаев    | Капитан, инженер-техник | Распределение командных задач, создание 3д моделей для генерации среды. Сбор информации для успешного написания программного кода. Отслеживание выполнения критериев, написание инструкции (документации) приложенной к работе.     |
| • Демьян Тарасов   | Инженер-программист     | Написание Backend части программного кода, отвечающего за полный полет дрона вдоль основной трубы, а также обнаружения врезок, сбор считанных данных и публикация их в топики.                                                      |
| • Тарас Резниченко | Программист             | Написание Backend части программного кода, подготовка среды, использования текстурных 3д моделей, создание системы случайной генерации врезок в главную трубу.                                                                      |
| • Михаил Ношин     | Программист             | Написание Frontend части программного кода, создание веб-интерфейса, который в свою очередь отображает найденные врезки в реальном времени. Считывание данных с топиков, публикациях их на страницу.                                |
| • Ирина Урих       | Наставник               | Изучение приложенного материала для выполнение задач 2 этапа, объяснение трудного материала. Выстраивание осмысленной и целенаправленной стратегии подготовки участников. Отзывчивость и помощь в случае возникновения затруднений. |
[^1]*Команда работала слаженно и ответственно, каждый участник являлся полезным звеном и не выбивался из рабочего процесса. Выполнял поставленные перед ним задачи, помогал остальным участникам команды. 

---

## 4. Установка виртуальной машины.

Для работы проекта используется виртуальная машина Clover с преднастроенным симулятором Gazebo и ROS. В качестве гипервизора можно использовать VirtualBox, VMware Player или VMware Workstation; в примере ниже разбирается VMware Workstation Pro.
(P.S. Мы используем WMVare, его рекомендуем к установке)

1. Установите ПО для виртуализации (VirtualBox, VMware Player или VMware Workstation Pro).
2. Перейдите по ссылке на релиз виртуальной машины Clover и скачайте образ:
   [Release v1.4 · CopterExpress/clover_vm](https://github.com/CopterExpress/clover_vm/releases/tag/v1.4)
3. Откройте установленное ПО для виртуализации и выберите пункт `File -> Open` (или сочетание клавиш `CTRL+O`), затем укажите скачанный файл образа `clover-devel_v1.4.ova`.
4. При импорте задайте имя виртуальной машины, например `Clover`.
5. После создания ВМ откройте её настройки:
   - `Memory`: выделите не менее половины доступной оперативной памяти хост‑системы (например, 8–12 ГБ при наличии 16 ГБ ОЗУ, чтобы ускорить работу симуляции).
   - `Processors`: установите 1 виртуальный процессор и 3 ядра (параметр `Number of cores per processor`).
   - `Network Adapter`: выберите тип соединения `NAT: Used to share the host's IP address` и установите флажок `Connect at power on`.
   Остальные параметры можно оставить по умолчанию. Нажмите `OK`, чтобы сохранить настройки.
---
## 5. Настройка симулятора и генерация мира с нефтепроводом

После установки виртуальной машины Clover и первого запуска симулятора необходимо подготовить окружение под задачу мониторинга нефтепровода.

1. Склонируйте наш репозиторий во внутрь виртуальной машины:
```
cd ~/Desktop
git clone https://github.com/krisikas/NTO-Banda-Goblinov.git
```
2. Перейдите в папку config репозитория и запустите файл конфигурации, который настраивает мир и параметры симуляции под задачу нефтепровода:
 ```
python3 /config/config.py
```
2. Затем сгенерируйте конфигурацию трубопровода (основная труба и врезки) с помощью скрипта gen_tubes.py:
```
python3 /config/gen_tubes.py
```
После выполнения этих шагов среда симуляции будет настроена: модели труб добавлены в Gazebo, параметры мира и конфигурация обновлены, и можно запускать основную программу полёта и мониторинга трубопровода.

---

## 6. Полётная миссия и сканирование трубопровода

Полёт вдоль нефтепровода и поиск врезок реализованы в папке `drone`, главный файл миссии — `main.py`.
### Структура кода

Проект разделён на несколько модулей для удобства разработки и поддержки:

- **`deps.py`** — класс `CloverDeps`, который инициализирует все ROS-сервисы (navigate, get_telemetry, land, arming), создаёт CvBridge для конвертации изображений и задаёт HSV-границы для цветовой фильтрации труб.
- **`functions.py`** — вспомогательные функции:
  - `navigate_wait()` — обёртка над навигацией с ожиданием достижения целевой точки
  - `proj_point()` — математическая функция проекции точки на отрезок (для вычисления координат врезок)
- **`part.py`** — функция `part()` для сканирования участка трубы: получает изображения с камеры, обрабатывает через OpenCV (HSV, маски, контуры), находит врезки и добавляет их координаты в массив.
- **`main.py`** — главный файл миссии, точка входа в программу.
### Логика выполнения миссии

Миссия предполагает один взлёт в точку (0, 0, 1) в системе координат `aruco_map`, после чего дрон последовательно облетает две части основной трубы нефтепровода и определяет координаты всех врезок с погрешностью не более ±0.5 м по каждой оси.

По ходу движения вдоль трубы дрон в реальном времени получает изображения с основной камеры, обрабатывает их с помощью OpenCV (конвертация в HSV, пороговая фильтрация, поиск контуров) и находит пересечения врезок с основной трубой по площади обнаруженных контуров.

Для каждой найденной врезки вычисляются координаты точки пересечения с основной трубой (x, y в `aruco_map`) и угол отхода врезки; данные добавляются в массив `tubes` в формате `{"x": cx, "y": cy, "angle": angle}`.

После завершения сканирования обеих частей трубопровода дрон возвращается в стартовую точку (0, 0, 1) и осуществляет посадку, при этом общее количество взлётов и посадок за миссию равно единице.```
### Запуск полетной миссии

```
python3 /drone/main.py
```

---

## 7. Веб-приложение для управления миссией

- Фронтенд: HTML + JavaScript (Socket.IO клиент) для визуализации карты, управления кнопками и отображения статуса в реальном времени.
- Бекенд: Flask + Socket.IO сервер, запущенный в main.py, обрабатывает REST API запросы и управляет WebSocket соединением.
- Связь с дроном: ROS нода подписывается и публикует в топики, которые транслируются через бекенд на фронтенд.

Данные обмениваются так: HTML (фронт) <==> REST API + WebSocket <==> Flask (бекенд) <==> ROS топики (дрон).
### Функциональность интерфейса

- 2D-карта трубопровода с основной трубой и визуализацией найденных врезок (ячейки 100×100 пикселей = 1 метр).
- Три кнопки управления: start (запуск), stop (посадка), kill switch (аварийная остановка).
- REST API:
  - GET /api/start — отправляет команду start
  - GET /api/stop — отправляет команду stop
  - GET /api/kill — отправляет команду kill
- Статус миссии: отображает состояние (действий не было, подключено, выполняется, остановлено, аварийная остановка).
- Координаты дрона: в реальном времени обновляются по x, y, z из сокета.
- Список найденных врезок: автоматически пополняется с информацией о каждой врезке.
### Запуск веб-сервера

1. Убедитесь, что установлены зависимости Flask и python-socketio:
### Запуск веб‑сервера

1. Установите зависимости Flask и python-socketio (если ещё не установлены):
```
тут от демы ответ
```

2. Запустите Flask сервер из папки front:
```
python3 front/main.py
```

4. Откройте браузер внутри виртуальной машины и перейдите:
```
http://localhost:4000/
```

В окне приложения видны: карта трубопровода с врезками, статус миссии, координаты дрона и список всех обнаруженных врезок.
P.S. если интерфейс не видно уменьшите мастшаб или увеличьте окно браузера:
чтобы изменить масштаб в браузере используйте сочетания клавиш: 'Ctrl' + '+' для увеличения, 'Ctrl' + '-' для уменьшения и 'Ctrl' + '0' для сброса к стандартному размеру. Также можно использовать меню браузера: нажмите на три точки или значок «Еще» и выберите «Увеличить» или «Уменьшить».

---
